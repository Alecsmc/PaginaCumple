<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Fiesta Romántica de Sheryl</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    html, body { width:100%; height:100%; overflow:hidden }
    body {
      position:relative;
      background:
        linear-gradient(135deg,#FFE5EC 0%,#FFF1E0 50%,#E0F7FA 100%),
        repeating-linear-gradient(45deg,rgba(255,255,255,0.1) 0 10px,transparent 10px 20px);
      font-family:sans-serif;
    }

    /* Título animado */
    #birthday-title {
      position:absolute; top:20px; left:50%;
      transform:translateX(-50%);
      background:rgba(255,255,255,0.8);
      padding:8px 16px; border-radius:8px; z-index:5;
      font-size:2.5rem;
      animation:colorChange 6s linear infinite;
    }
    @keyframes colorChange {
      0%{color:#FF6384}25%{color:#36A2EB}50%{color:#4BC0C0}
      75%{color:#9966FF}100%{color:#FFCE56}
    }

    /* Decoración */
    #bunting {
      position:absolute; top:80px; left:50%;
      transform:translateX(-50%); display:flex; gap:6px; z-index:3;
    }
    .flag {
      width:0; height:0;
      border-left:14px solid transparent;
      border-right:14px solid transparent;
      border-bottom:24px solid var(--clr);
    }
    #balloon-bg {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      background:url('assets/balloon_bg_pastel.png') no-repeat center bottom;
      background-size:cover; opacity:0.5; z-index:0;
    }

    /* Corazones y globos */
    .heart { /* ...igual que antes... */ }
    .balloon-emoji { /* ...igual que antes... */ }

    /* Contenedor de escena */
    #scene {
      position:absolute; bottom:30px; left:50%;
      transform:translateX(-50%);
      width:800px; height:400px;
      overflow:hidden;
    }

    /* Canvas de Sheryl */
    #gameCanvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      background:
        url('assets/church_bg.png') no-repeat center bottom,
        rgba(255,255,255,0.7);
      background-size:cover;
      border:2px solid #FFC0CB; border-radius:12px;
      z-index:1;
    }

    /* Snoopy esperando con torta */
    #snoopy-wait {
      position:absolute; bottom:0; right:10px;
      /* width y height los pondremos dinámicamente en JS */
      image-rendering:pixelated; z-index:2;
      transform:scaleX(-1);
      animation:
        anxiousBounce 1s ease-in-out infinite,
        flicker       0.2s infinite alternate;
    }
    @keyframes anxiousBounce {
      0%,100% { transform: scaleX(-1) translateY(0); }
      50%     { transform: scaleX(-1) translateY(-6px); }
    }
    @keyframes flicker {
      0%{filter:brightness(1)}50%{filter:brightness(1.4)}100%{filter:brightness(1)}
    }

    #music { display:none }
  </style>
</head>
<body>
  <div id="balloon-bg"></div>
  <div id="bunting">
    <div class="flag" style="--clr:#FF6384"></div>
    <div class="flag" style="--clr:#FFCE56"></div>
    <div class="flag" style="--clr:#36A2EB"></div>
    <div class="flag" style="--clr:#4BC0C0"></div>
    <div class="flag" style="--clr:#9966FF"></div>
  </div>
  <h1 id="birthday-title">¡Feliz Cumpleaños, Sheryl!</h1>

  <div id="scene">
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    <img id="snoopy-wait" src="snoopy_cake_wait.png" alt="Snoopy esperando">
  </div>

  <audio id="music" src="birthday_song.mp3" autoplay loop></audio>

  <script>
    const canvas       = document.getElementById('gameCanvas'),
          ctx          = canvas.getContext('2d'),
          snoopyImgEl  = document.getElementById('snoopy-wait'),
          FLOOR_H      = 30;

    ctx.imageSmoothingEnabled = false;

    // 1) Control de Sheryl con teclado
    const sherylSprite = new Image();
    sherylSprite.src   = 'sheryl_sprite_6frames_finalclean.png';

    const FRAMES       = 6;
    let frameW, frameH,
        x = 0, y = 0,
        frame = 0, lastTS = 0,
        stopped = false,
        direction = 1; // 1: derecha, -1: izquierda

    const SPEED         = 2;
    const keys          = { ArrowLeft:false, ArrowRight:false };
    const collisionMargin = 10;
    let snoopyWidth;   // ancho dinámico de Snoopy, asignado tras resize
    // --------------

    // Teclas
    document.addEventListener('keydown', e => {
      if (e.key==='ArrowLeft')  keys.ArrowLeft  = true, direction = -1;
      if (e.key==='ArrowRight') keys.ArrowRight = true, direction =  1;
    });
    document.addEventListener('keyup', e => {
      if (e.key==='ArrowLeft')  keys.ArrowLeft  = false;
      if (e.key==='ArrowRight') keys.ArrowRight = false;
    });

    sherylSprite.onload = () => {
      // calculamos tamaño de un frame de Sheryl
      frameW = sherylSprite.width / FRAMES;
      frameH = sherylSprite.height;
      y      = canvas.height - FLOOR_H - frameH;

      // 2) Ajustamos Snoopy a esa altura
      snoopyImgEl.style.height = frameH + 'px';
      snoopyImgEl.style.width  = 'auto';
      // leemos su ancho real en px
      snoopyWidth = snoopyImgEl.getBoundingClientRect().width;

      requestAnimationFrame(loop);
    };

    function loop(ts) {
      if (!lastTS) lastTS = ts;
      const delta = ts - lastTS;

      // animar frames si hay movimiento y no chocó
      if (delta > 150 && (keys.ArrowLeft||keys.ArrowRight) && !stopped) {
        frame = (frame+1) % FRAMES;
        lastTS = ts;
      }

      // mover
      if (!stopped) {
        if (keys.ArrowRight) {
          if (x + frameW < canvas.width - snoopyWidth - collisionMargin) {
            x += SPEED;
          }
        }
        if (keys.ArrowLeft) {
          if (x > 0) x -= SPEED;
        }
      }

      // comprobar colisión
      if (!stopped && x + frameW >= canvas.width - snoopyWidth - collisionMargin) {
        stopped = true;
      }

      // dibujar
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // suelo
      ctx.fillStyle = '#8B4513';
      ctx.fillRect(0, canvas.height - FLOOR_H, canvas.width, FLOOR_H);

      // Sheryl espejada según direction
      ctx.save();
      if (direction === -1) {
        ctx.translate(x + frameW/2, 0);
        ctx.scale(-1, 1);
        ctx.translate(-x - frameW/2, 0);
      }
      ctx.drawImage(
        sherylSprite,
        frame * frameW, 0, frameW, frameH,
        x, y, frameW, frameH
      );
      ctx.restore();

      requestAnimationFrame(loop);
    }

    // (corazones, globos y música igual que antes…)
  </script>
</body>
</html>
