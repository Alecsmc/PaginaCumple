<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sorpresa Cumpleaños</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    html, body {
      width: 100%; height: 100%; overflow: hidden;
      font-family: sans-serif;
      touch-action: none;
    }
    body {
      position:relative;
      background:
        linear-gradient(135deg,#FFE5EC 0%,#FFF1E0 50%,#E0F7FA 100%),
        repeating-linear-gradient(45deg,rgba(255,255,255,0.1) 0 10px,transparent 10px 20px);
    }
    #birthday-title {
      position:absolute; top:20px; left:50%; transform:translateX(-50%);
      background:rgba(255,255,255,0.8); padding:8px 16px;
      border-radius:8px; z-index:5; font-size:2.2rem;
      animation:colorChange 6s linear infinite;
    }
    @keyframes colorChange {
      0%{color:#FF6384}25%{color:#36A2EB}50%{color:#4BC0C0}75%{color:#9966FF}100%{color:#FFCE56}
    }
    #bunting {
      position:absolute; top:80px; left:50%; transform:translateX(-50%);
      display:flex; gap:6px; z-index:3;
    }
    .flag {
      width:0; height:0; border-left:14px solid transparent;
      border-right:14px solid transparent;
      border-bottom:24px solid var(--clr);
    }
    #confetti-container, .balloon {
      position: absolute;
      pointer-events: none;
    }
    .confetti {
      position: absolute;
      width: 8px; height: 8px;
      background-color: red;
      animation: confettiFall linear infinite;
    }
    @keyframes confettiFall {
      0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
    }
    .balloon {
      width: 30px; height: 45px; border-radius: 50%; opacity: 0.8;
      animation: floatUp 6s ease-in infinite;
    }
    .balloon::after {
      content: '';
      position: absolute;
      bottom: -10px; left: 50%; transform: translateX(-50%);
      width: 2px; height: 20px;
      background: black;
    }
    @keyframes floatUp {
      0% { transform: translateY(0); opacity: 0.2; }
      30% { opacity: 1; }
      100% { transform: translateY(-100vh); opacity: 0; }
    }

    #scene {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 800px;
      aspect-ratio: 2 / 1;
      overflow: hidden;
      background: linear-gradient(to top, #4CAF50 0%, #A8E6A3 60%, #D0F7DC 100%);
      border-radius: 12px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
    }
    #scene::before, #scene::after {
      content: '';
      position: absolute;
      bottom: 30px;
      width: 40px;
      height: 60px;
      background: radial-gradient(circle at 50% 20%, #2E7D32 40%, #1B5E20 100%);
      border-radius: 50%;
      z-index: 0;
    }
    #scene::before {
      left: 40px;
    }
    #scene::after {
      right: 40px;
    }

    #gameCanvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      background: rgba(255,255,255,0.7);
      border:2px solid #FFC0CB; border-radius:12px; z-index:1;
    }
    #snoopy-wait {
      position:absolute; bottom:0; right:10px;
      image-rendering:pixelated; z-index:2;
      transform:scaleX(-1);
      animation:anxiousBounce 1s ease-in-out infinite, flicker 0.2s infinite alternate;
    }
    @keyframes anxiousBounce {
      0%,100% { transform: scaleX(-1) translateY(0); }
      50%     { transform: scaleX(-1) translateY(-6px); }
    }
    @keyframes flicker {
      0%{filter:brightness(1)}50%{filter:brightness(1.4)}100%{filter:brightness(1)}
    }
    #mensaje-camino {
      position: absolute;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.5rem;
      background: rgba(255, 255, 255, 0.7);
      padding: 8px 12px;
      border-radius: 8px;
      z-index: 10;
    }
    #touch-controls {
      position:fixed; bottom:10px; left:50%; transform:translateX(-50%);
      z-index:9999; display:flex; gap:20px;
    }
    #touch-controls button {
      font-size:2rem; padding:10px 20px; border-radius:12px; border:none;
      background-color:rgba(255,255,255,0.9);
      box-shadow:2px 2px 6px rgba(0,0,0,0.3);
      cursor:pointer; user-select:none;
    }
    #final-screen {
      display:none; position:fixed; top:0; left:0;
      width:100vw; height:100vh; background:#fffdf2;
      z-index:99999; display:flex; align-items:center; justify-content:center; padding:20px;
      flex-direction: column;
    }
    #final-toggle-img {
      max-width: 100%; max-height: 90vh; border-radius: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.4); cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="confetti-container"></div>
  <div id="bunting">
    <div class="flag" style="--clr:#FF6384"></div>
    <div class="flag" style="--clr:#FFCE56"></div>
    <div class="flag" style="--clr:#36A2EB"></div>
    <div class="flag" style="--clr:#4BC0C0"></div>
    <div class="flag" style="--clr:#9966FF"></div>
  </div>
  <h1 id="birthday-title">¡Feliz Cumpleaños, Sheryl!</h1>
  <div id="mensaje-camino">¡Vamos a encontrarnos con Snoopy!</div>
  <div id="scene">
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    <img id="snoopy-wait" src="snoopy_cake_wait.png" alt="Snoopy esperando">
  </div>
  <div id="touch-controls">
    <button id="left-btn" tabindex="-1">⬅️</button>
    <button id="right-btn" tabindex="-1">➡️</button>
  </div>
  <div id="final-screen">
    <img id="final-toggle-img" src="final_card.png" alt="Feliz cumple">
  </div>
  <script>
    const canvas = document.getElementById('gameCanvas'),
          ctx = canvas.getContext('2d'),
          snoopyImgEl = document.getElementById('snoopy-wait'),
          finalScreen = document.getElementById('final-screen'),
          toggleImg = document.getElementById('final-toggle-img'),
          mensaje = document.getElementById('mensaje-camino'),
          confettiContainer = document.getElementById('confetti-container'),
          FLOOR_H = 30;

    ctx.imageSmoothingEnabled = false;
    const sherylSprite = new Image();
    sherylSprite.src = 'sheryl_sprite_6frames_finalclean.png';
    const FRAMES = 6;
    let frameW, frameH, x = 0, y = 0,
        frame = 0, lastTS = 0,
        stopped = false,
        direction = 1,
        SPEED = 2,
        snoopyWidth,
        currentImage = 0;

    const keys = { ArrowLeft:false, ArrowRight:false };

    document.addEventListener('keydown', e => {
      if (e.key==='ArrowLeft') keys.ArrowLeft = true, direction = -1;
      if (e.key==='ArrowRight') keys.ArrowRight = true, direction = 1;
    });
    document.addEventListener('keyup', e => {
      if (e.key==='ArrowLeft') keys.ArrowLeft = false;
      if (e.key==='ArrowRight') keys.ArrowRight = false;
    });
    document.getElementById('left-btn').addEventListener('touchstart', () => keys.ArrowLeft = true);
    document.getElementById('left-btn').addEventListener('touchend', () => keys.ArrowLeft = false);
    document.getElementById('right-btn').addEventListener('touchstart', () => keys.ArrowRight = true);
    document.getElementById('right-btn').addEventListener('touchend', () => keys.ArrowRight = false);

    sherylSprite.onload = () => {
      frameW = sherylSprite.width / FRAMES;
      frameH = sherylSprite.height;
      y = canvas.height - FLOOR_H - frameH;
      snoopyImgEl.style.height = frameH + 'px';
      snoopyImgEl.style.width = 'auto';
      finalScreen.style.display = 'none';
      setTimeout(() => {
        snoopyWidth = snoopyImgEl.offsetWidth / (canvas.offsetWidth / canvas.width);
      }, 50);
      requestAnimationFrame(loop);
    };

    function showFinalScreen() {
      document.getElementById('scene').style.display = 'none';
      document.getElementById('bunting').style.display = 'none';
      document.getElementById('birthday-title').style.display = 'none';
      document.getElementById('touch-controls').style.display = 'none';
      mensaje.style.display = 'none';
      finalScreen.style.display = 'flex';
      for (let i = 0; i < 50; i++) launchConfetti();
      for (let i = 0; i < 20; i++) createBalloon();
    }

    function launchConfetti() {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = Math.random() * 100 + 'vw';
      confetti.style.backgroundColor = ['#FF6384', '#36A2EB', '#FFCE56', '#9966FF'][Math.floor(Math.random() * 4)];
      confetti.style.animationDuration = 2 + Math.random() * 3 + 's';
      confettiContainer.appendChild(confetti);
      setTimeout(() => confetti.remove(), 5000);
    }

    function createBalloon() {
      const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#9966FF', '#4BC0C0'];
      const balloon = document.createElement('div');
      balloon.className = 'balloon';
      balloon.style.left = Math.random() * 100 + 'vw';
      balloon.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      balloon.style.animationDuration = (6 + Math.random() * 4) + 's';
      document.body.appendChild(balloon);
      setTimeout(() => balloon.remove(), 10000);
    }

    toggleImg.addEventListener('click', () => {
      currentImage = (currentImage + 1) % 2;
      toggleImg.src = currentImage === 0 ? 'final_card.png' : 'final_card_2.png';
    });

    function loop(ts) {
      if (!lastTS) lastTS = ts;
      const delta = ts - lastTS;
      if (delta > 150 && (keys.ArrowLeft || keys.ArrowRight) && !stopped) {
        frame = (frame + 1) % FRAMES;
        lastTS = ts;
      }
      if (!stopped) {
        if (keys.ArrowRight && x + frameW < canvas.width - snoopyWidth - 10) x += SPEED;
        if (keys.ArrowLeft && x > 0) x -= SPEED;
      }

      if (x > 200 && x < 300) mensaje.textContent = "¡Ya casi llegas!";
      if (x >= 300) mensaje.textContent = "¡Estás muy cerca!";

      if (!stopped && x + frameW >= canvas.width - snoopyWidth - 10) {
        stopped = true;
        showFinalScreen();
        return;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#8B4513';
      ctx.fillRect(0, canvas.height - FLOOR_H, canvas.width, FLOOR_H);
      ctx.save();
      if (direction === -1) {
        ctx.translate(x + frameW, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(sherylSprite, frame * frameW, 0, frameW, frameH, 0, y, frameW, frameH);
      } else {
        ctx.drawImage(sherylSprite, frame * frameW, 0, frameW, frameH, x, y, frameW, frameH);
      }
      ctx.restore();
      requestAnimationFrame(loop);
    }
  </script>
</body>
</html>
