<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Sorpresa Cumplea√±os</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    html, body {
      width:100%; height:100%; overflow:hidden; overflow-x:hidden;
      font-family:sans-serif; touch-action:none;
    }
    body {
      position:relative;
      background:
        linear-gradient(135deg,#FFE5EC 0%,#FFF1E0 50%,#E0F7FA 100%),
        repeating-linear-gradient(45deg,rgba(255,255,255,0.1) 0 10px,transparent 10px 20px);
    }

    /* ---- T√çTULO ANIMADO ---- */
    #birthday-title {
      position:absolute; top:20px; left:50%;
      transform:translateX(-50%);
      background:linear-gradient(135deg,#fff5f8,#e0f7fa);
      padding:1rem 2rem; border-radius:1.25rem;
      font-size:2.4rem; font-weight:bold; color:#cc3366;
      text-align:center; text-shadow:1px 1px #fff;
      border:2px dashed #ff80ab;
      box-shadow:0 6px 18px rgba(0,0,0,0.15);
      animation:bounceTitle 2s ease infinite;
      z-index:10;
    }
    @keyframes bounceTitle {
      0%,100%{transform:translateX(-50%) translateY(0)}
      50%{transform:translateX(-50%) translateY(-6px)}
    }

    /* ---- BANDERINES ---- */
    #bunting {
      position:absolute; top:80px; left:50%;
      transform:translateX(-50%);
      display:flex; gap:6px; z-index:3;
    }
    .flag {
      width:0; height:0;
      border-left:14px solid transparent;
      border-right:14px solid transparent;
      border-bottom:24px solid var(--clr);
    }

    /* ---- REGALOS EN PISTA ---- */
    .gift {
      position:absolute; bottom:30px;
      width:44px; height:44px;
      background:linear-gradient(145deg,#4ca5ff,#1976d2);
      border-radius:6px; border:1px solid #fff;
      box-shadow:inset -3px -3px 6px rgba(255,255,255,0.3), 0 4px 12px rgba(0,0,0,0.4);
      transition:transform .3s,opacity .3s;
      z-index:3;
    }
    .gift.collected { transform:scale(0); opacity:0 }
    .gift .bow {
      position:absolute; top:-10px; left:50%;
      transform:translateX(-50%);
      width:14px; height:14px;
      background:radial-gradient(circle at center,#ff5252,#b71c1c);
      border-radius:50%; box-shadow:0 0 4px rgba(0,0,0,0.2);
    }

    /* ---- ESCENA Y CANVAS ---- */
    #scene {
      position:absolute; bottom:80px; left:50%;
      transform:translateX(-50%);
      width:100%; max-width:800px; aspect-ratio:2/1;
      overflow:hidden;
      background:url('fondo_pasto_casita.png') center bottom no-repeat;
      background-size:cover;
      border-radius:12px; box-shadow:0 0 8px rgba(0,0,0,0.2);
      padding:0 1rem; box-sizing:border-box;
    }
    #gameCanvas {
      position:absolute; top:0; left:0;
      width:100% !important; height:auto !important;
      background:rgba(255,255,255,0.3);
      border:2px solid #FFC0CB; border-radius:12px;
      z-index:1;
    }

    /* ---- SNOOPY ESPERANDO & RESPONSIVE ---- */
    #snoopy-wait {
      position:absolute; bottom:0;
      image-rendering:pixelated;
      transform:scaleX(-1);
      animation:anxiousBounce 1s ease-in-out infinite,
                 flicker 0.2s infinite alternate;
      /* l√≠mites responsive */
      width:auto !important; height:auto !important;
      max-width:25%; max-height:60%;
      right:5%; z-index:5;
    }
    @keyframes anxiousBounce {
      0%,100%{transform:scaleX(-1) translateY(0)}
      50%{transform:scaleX(-1) translateY(-6px)}
    }
    @keyframes flicker {
      0%{filter:brightness(1)}50%{filter:brightness(1.4)}100%{filter:brightness(1)}
    }

    /* ---- MENSAJE FLOTANTE ---- */
    #mensaje-camino {
      position:absolute; top:170px; left:50%;
      transform:translateX(-50%);
      max-width:80vw;
      background:rgba(255,255,255,0.95);
      padding:.5rem 1rem; border-radius:8px;
      font-size:1.2rem; font-weight:500; color:#444;
      text-align:center; z-index:9;
    }

    /* ---- CONTROLES T√ÅCTILES ---- */
    #touch-controls {
      position:fixed; bottom:5%; left:50%;
      transform:translateX(-50%);
      display:flex; gap:20px; z-index:10;
    }
    #touch-controls button {
      font-size:2rem; min-width:48px; min-height:48px;
      padding:.5rem 1rem; border:none; border-radius:12px;
      background:rgba(255,255,255,0.9);
      box-shadow:2px 2px 6px rgba(0,0,0,0.3);
      cursor:pointer; user-select:none;
    }

    /* ---- EFECTOS DECORATIVOS ---- */
    .confetti, .balloon, .drop-gift, .star {
      pointer-events:none;
    }
    /* Aqu√≠ ir√≠an tus keyframes para confetti, globos, etc. */

    /* ---- GIFT PYRAMID / TOWER ---- */
    #gift-tower {
      position:absolute; right:20px; bottom:30px;
      display:flex; flex-direction:column; align-items:center; gap:6px;
      z-index:2;
    }
    .gift-tower-box {
      width:40px; height:40px;
      background:linear-gradient(145deg,#ff80ab,#ec407a);
      border-radius:6px; border:1px solid #fff;
      box-shadow:inset -3px -3px 6px rgba(255,255,255,0.3),0 4px 12px rgba(0,0,0,0.3);
      position:relative;
    }
    .gift-tower-box::before, .gift-tower-box::after {
      content:''; position:absolute; background:#fff; z-index:2;
    }
    .gift-tower-box::before {
      width:100%; height:5px; top:50%; left:0; transform:translateY(-50%);
    }
    .gift-tower-box::after {
      width:5px; height:100%; top:0; left:50%; transform:translateX(-50%);
    }
    #gift-pyramid {
      position:absolute; bottom:30px; left:50%;
      transform:translateX(-50%);
      display:flex; flex-direction:column-reverse; align-items:center; gap:4px;
      z-index:1;
    }
    #gift-pyramid .row {
      display:flex; gap:4px; justify-content:center;
    }

    /* ---- RESPONSIVE ---- */
    @media (max-width:360px){
      #birthday-title{font-size:1.8rem;padding:.5rem 1rem}
      #mensaje-camino{font-size:1rem;top:120px}
      .confetti,.balloon,.drop-gift,.star{display:none!important}
      .flag{border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:18px solid var(--clr)}
      #touch-controls button{font-size:1.25rem;min-width:40px;min-height:40px}
    }
    @media (min-width:361px) and (max-width:600px){
      #birthday-title{font-size:2.2rem;padding:.75rem 1.5rem}
      #mensaje-camino{font-size:1.1rem;top:140px}
    }
  </style>
</head>
<body>
  <div id="gift-tower">
    <div class="gift-tower-box"></div>
    <div class="gift-tower-box"></div>
    <div class="gift-tower-box"></div>
    <div class="gift-tower-box"></div>
  </div>
  <div id="garland"></div>
  <div id="effect-container"></div>
  <div id="effect-container"></div>
  <div id="bunting">
    <div class="flag" style="--clr:#FF6384"></div>
    <div class="flag" style="--clr:#FFCE56"></div>
    <div class="flag" style="--clr:#36A2EB"></div>
    <div class="flag" style="--clr:#4BC0C0"></div>
    <div class="flag" style="--clr:#9966FF"></div>
  </div>
  <h1 id="birthday-title">üéâ ¬°Snoopy tiene una sorpresa de cumplea√±os, Sheryl! üéÅ</h1>
  <div id="mensaje-camino">Camina y recoge los regalos... ¬°Snoopy tiene algo especial para ti! üéÇ</div>

  <div id="scene">
    <div id="gift-pyramid">
      <div class="row">
        <div class="gift-tower-box"></div>
        <div class="gift-tower-box"></div>
        <div class="gift-tower-box"></div>
      </div>
      <div class="row">
        <div class="gift-tower-box"></div>
        <div class="gift-tower-box"></div>
      </div>
      <div class="row">
        <div class="gift-tower-box"></div>
      </div>
    </div>
    <canvas id="gameCanvas" width="800" height="400"></canvas>
    <div id="gifts-container"></div>
    <img id="snoopy-wait" src="snoopy_cake_wait.png" alt="Snoopy esperando">
  </div>

  <div id="touch-controls">
    <button id="left-btn">‚¨ÖÔ∏è</button>
    <button id="right-btn">‚û°Ô∏è</button>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas'),
          ctx    = canvas.getContext('2d'),
          mensaje= document.getElementById('mensaje-camino'),
          giftContainer = document.getElementById('gifts-container'),
          FLOOR_H=50;

    ctx.imageSmoothingEnabled = false;
    const sheryl = new Image();
    sheryl.src = 'sheryl_sprite_6frames_finalclean.png';

    // precarga piso
    const floorSrcs = ['gorro1.png','dulce1.png','gorro2.png','caramelo2.png'];
    const floors = floorSrcs.map(src=>{let i=new Image(); i.src=src; return i;});

    // efectos
    let fxInterval;
    function pruneEffects(){
      let c=document.getElementById('effect-container');
      while(c.children.length>100) c.removeChild(c.firstChild);
    }
    function launchAll(){
      pruneEffects();
      const colors=['#FF6384','#36A2EB','#FFCE56','#9966FF','#4BC0C0'];
      // confetti
      for(let i=0;i<30;i++){
        let c=document.createElement('div');
        c.className='confetti';
        c.style.left=Math.random()*100+'vw';
        c.style.top='-10px';
        c.style.backgroundColor=colors[i%colors.length];
        c.style.animationDuration=(3+Math.random()*2)+'s';
        document.getElementById('effect-container').append(c);
        setTimeout(()=>c.remove(),6000);
      }
      // globos
      for(let i=0;i<10;i++){
        let b=document.createElement('div');
        b.className='balloon';
        b.style.left=Math.random()*100+'vw';
        b.style.backgroundColor=colors[i%colors.length];
        b.style.animationDuration=(6+Math.random()*4)+'s';
        document.getElementById('effect-container').append(b);
        setTimeout(()=>b.remove(),10000);
      }
      // drop gifts
      for(let i=0;i<6;i++){
        let g=document.createElement('div');
        g.className='drop-gift';
        g.style.left=Math.random()*100+'vw';
        g.style.animationDuration=(4+Math.random()*3)+'s';
        document.getElementById('effect-container').append(g);
        setTimeout(()=>g.remove(),7000);
      }
      // estrellas
      for(let i=0;i<15;i++){
        let s=document.createElement('div');
        s.className='star';
        s.style.left=Math.random()*100+'vw';
        s.style.top=Math.random()*60+'px';
        document.getElementById('effect-container').append(s);
      }
    }
    function startFX(){ launchAll(); fxInterval=setInterval(launchAll,6000); }
    function stopFX(){ clearInterval(fxInterval); }
    document.addEventListener('visibilitychange',()=>{
      document.hidden? stopFX(): startFX();
    });

    // juego
    const FRAMES=6;
    let frameW, frameH, frame=0, lastTS=0,
        x=0,y=0,speed=2,dir=1,stopped=false,sw=0;

    const keys={ArrowLeft:false,ArrowRight:false};
    ['ArrowLeft','ArrowRight'].forEach(k=>{
      document.addEventListener('keydown',e=>{if(e.key===k)keys[k]=true,dir=k==='ArrowLeft'?-1:1});
      document.addEventListener('keyup',e=>{if(e.key===k)keys[k]=false});
    });
    document.getElementById('left-btn').addEventListener('touchstart',()=>keys.ArrowLeft=true);
    document.getElementById('left-btn').addEventListener('touchend',()=>keys.ArrowLeft=false);
    document.getElementById('right-btn').addEventListener('touchstart',()=>keys.ArrowRight=true);
    document.getElementById('right-btn').addEventListener('touchend',()=>keys.ArrowRight=false);

    function renderGifts(){
      let positions=Array.from({length:10},()=>Math.random()*(canvas.width-60)+30);
      positions.forEach((pos,i)=>{
        let d=document.createElement('div');
        d.className='gift'; d.style.left=pos+'px'; d.dataset.giftId=i;
        let b=document.createElement('div'); b.className='bow';
        d.append(b); giftContainer.append(d);
      });
    }

    function showFinal(){
      stopped=true;
      document.getElementById('scene').style.display='none';
      document.getElementById('bunting').style.display='none';
      document.getElementById('birthday-title').style.display='none';
      document.getElementById('touch-controls').style.display='none';
      mensaje.style.display='none';
      let fs=document.createElement('div');
      fs.id='final-screen';
      fs.style.cssText=
        'position:fixed;top:0;left:0;width:100vw;height:100vh;'+
        'background:#fffdf2;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:20px;z-index:99999;';
      let ti=document.createElement('img');
      ti.id='final-toggle-img'; ti.src='final_card.png';
      ti.style.cssText='max-width:100%;max-height:90vh;border-radius:16px;box-shadow:0 0 20px rgba(0,0,0,0.4);cursor:pointer;';
      let cur=0;
      ti.addEventListener('click',()=>{cur=1-cur; ti.src=cur?'final_card_2.png':'final_card.png'});
      fs.append(ti); document.body.append(fs);
    }

    sheryl.onload=()=>{
      frameW=sheryl.width/FRAMES;
      frameH=sheryl.height;
      y=canvas.height-FLOOR_H-frameH;
      setTimeout(()=>{sw=document.getElementById('snoopy-wait').offsetWidth/(canvas.offsetWidth/canvas.width)},50);
      renderGifts();
      startFX();
      requestAnimationFrame(loop);
    };

    window.addEventListener('resize',()=>{
      clearTimeout(window._resizeTimer);
      window._resizeTimer=setTimeout(()=>{
        canvas.style.width='100%'; canvas.style.height='auto';
        let h=document.getElementById('scene').clientHeight;
        document.getElementById('snoopy-wait').style.maxHeight=(h*0.6)+'px';
      },200);
    });

    function loop(ts){
      if(!lastTS) lastTS=ts;
      let delta=ts-lastTS;
      if(delta>150&&(keys.ArrowLeft||keys.ArrowRight)&&!stopped){ frame=(frame+1)%FRAMES; lastTS=ts; }
      if(!stopped){
        if(keys.ArrowRight&&x+frameW<canvas.width-sw-10) x+=speed;
        if(keys.ArrowLeft&&x>0) x-=speed;
      }
      document.querySelectorAll('.gift').forEach(g=>{
        let gx=+g.style.left.replace('px','');
        if(!g.classList.contains('collected')&&x+frameW>gx&&x<gx+30) g.classList.add('collected');
      });
      if(x>200&&x<300) mensaje.textContent='¬°Ya casi llegas!';
      if(x>=300)       mensaje.textContent='¬°Est√°s muy cerca!';
      if(!stopped&&x+frameW>=canvas.width-sw-10){ showFinal(); return; }
      ctx.clearRect(0,0,canvas.width,canvas.height);
      for(let i=0;i<canvas.width;i+=40){
        ctx.drawImage(floors[(i/40)%floors.length],i,canvas.height-FLOOR_H,40,FLOOR_H);
      }
      ctx.save();
      if(dir<0){
        ctx.translate(x+frameW,0); ctx.scale(-1,1);
        ctx.drawImage(sheryl,frame*frameW,0,frameW,frameH,0,y,frameW,frameH);
      } else {
        ctx.drawImage(sheryl,frame*frameW,0,frameW,frameH,x,y,frameW,frameH);
      }
      ctx.restore();
      requestAnimationFrame(loop);
    }
  </script>
</body>
</html>
